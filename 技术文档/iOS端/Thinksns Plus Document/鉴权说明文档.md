2017年08月29日18:09:02 文档校对

该应用鉴权依据[服务器认证概述](https://github.com/zhiyicx/thinksns-plus/blob/master/documents/api/v1/%E8%87%AA%E5%8A%A8%E8%AE%A4%E8%AF%81%E6%A6%82%E8%BF%B0.md)编写完成.

即时聊天鉴权部分依据[聊天授权说明](https://github.com/zhiyicx/thinksns-plus/blob/master/documents/api/v1/%E8%81%8A%E5%A4%A9%E6%8E%88%E6%9D%83%E8%AF%B4%E6%98%8E.md)编写.

## 鉴权概述

该应用会记录且持久化当前登录用户相关授权信息,提供单例`./Global/TSCurrentUserInfo.swift`供随时调用.

当用户登录或注册时,会向服务器请求通行口令,成功获取请求口令后持久化该口令.当用户注销或退出本应用后,会清空口令并且删除持久化口令信息.

当移动端请求服务器端时,部分白名单接口可以不需要口令就可以访问(例如注册接口).其余非白名单接口访问时,必须将后台提供的口令写入每次`http`请求请求头中才能正常访问.

如果访问非白名单接口失败或者用户口令授权过期后,移动端使用刷新口令访问服务端刷新口令接口,更新口令.(服务端根据管理员配置权限以及刷新口令有效期决定更新结果)如果更新口令失败,将主动注销用户,清空口令并且删除持久化口令信息.

### 即时聊天鉴权

即时聊天部分的鉴权依附于用户鉴权,当用户首次注册或者登录后,会使用口令换取即时聊天登录密码.当用户口令授权过期后,成功获取到新的口令后,使用新的口令更新即时聊天登录密码.

### 类关系说明

1. `TSAccountNetworkManager`负责用户登录注册获取口令以及刷新口令的网络请求.`TSIMAccountNetworkManager`负责即时聊天口令获取和刷新的网络请求.
2. `TSAccountTokenModel`负责网络请求返回的数据处理.`IMTokenModel`负责即时聊天的数据处理.
3. `TSCurrentUserInfo`记录口令方便使用.
4. `TSRootViewController`在应用初始化后会首先创建,然后负责检查授权状态,是否发起刷新请求.同时负责处理访问非白名单接口失败时,注销应用的逻辑.
5. `TSSettingVC`注销后,清空授权信息.

### 多设备登录处理

当同一个用户使用多设备登录时或者授权口令过期后,服务端会抛出 statusCode 401 的错误码,移动端让该用户注销.
