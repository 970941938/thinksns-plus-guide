2017年03月09日09:29:10 文档校验
该文档还在完善当中

# 数据库说明文档

数据库基于[RealmSwift 2.4.2](https://realm.io/docs/swift/latest/)开发.为了增强移动端用户体验(用户接入页面后可以尽快显示数据),故将尽量多的服务端提供的信息持久化在本地,并且UI需要的数据总是优先从数据库获取,同时发起异步网络请求,稍后更新数据库和UI.依据不同的接口使用不用的更新写入逻辑.

[RealmSwift 2.4.2 说明文档](https://realm.io/cn/docs/swift/latest/)

## 文件目录说明

```shell
.
TSDataBase
    ├── TSDataBaseManager.swift		 	: 数据库管理类(提供访问所有数据库管理类的访问接口)
    ├── UserDataBase					:用户数据库管理类
    │   └─── Object                     : 用户数据库表模型
    └── OtherDataBase					:示例数据库管理类
        └─── Object                     : 示例数据库表模型

```


## 一.用户数据库

### 1.表设计说明

数据库分为用户关系表,用户信息表.

### 1.1 用户关系表

用户关系表上记录所有的登录用户相关的用户关系.

为了应对不同的用户登录单一设备的用户场景,故该表字段做如下设计:

|  索引主键  | 用户标识 | 关系状态 | 被关注 |
|----|----|----|----|
| id | followingIdentity | state | followedIdentity | 

备注: 

1. `state`分为 0,1 等标识不同的关系,这里用 A 代指 followingIdentity, B 代指 followedIdentity

- 0: 表示 A 没有关注 B，但是 B 关没关注 A 不可知
- 1: 表示 A 关注了 B，但是 B 关没关注 A 不可知

2. `id`作为主键来确定唯一性

3. `id`、 `followingIdentity `、` followedIdentity ` 、`state`作为关键索引key增加搜索速度.

该表不会被主动清空,也不给用户删除该表的权利.

> 更新,修改逻辑

初次使用时,等待写入服务端数据即可.当后续使用过程中,服务器端增加了更多的数据后,依次检查本地是否需要修改数据,再依次写入或者修改数据库即可.

当用户操作时,首先修改数据库数据并且标记为`待同步`状态,即刻更新UI.稍微等待和服务器同步结果,成功后将该数据标记为`正常`状态,失败后标记为`同步失败`状态,按需显示不同的UI状态,或者稍后再进行和服务器同步.

### 1.2 用户信息表

用户信息表分为固定数据和动态数据,设计的目的是为了方便后续增加用户信息内容.

表 infoKeyList 记录配置关键字,分为基础配置信息和运行时增加配置信息.

表 infoValueList 记录真实的用户数据,但是需要配置表A存储和查询.

| 用户标识 | 用户名 | 性别 | 地址 | 简介 | 学历 | 省 | 市 | 区 | 动态数据 key | 动态数据 value |
|----|----|----|----|----|----|----|----|----|----|----|----|
| userIdentity | name | sex | location | intro | education | province | city | area | infoKeyList | infoValueList |

* 当前没有需要设置为动态的数据，动态数据是为后期做准备

### 2. 表使用说明

### 2.1 获取用户数据
由于 Realm 的 instance 只能在其被创建的线程中使用，为了方便更新 UI，故获取用户信息是在主线程进行的操作

### 2.2 写入用户数据
新增了写入多个用户的方法，该方法有一个 complete 的 block 回调，请保证 block 回调之前不会调用相同的写入方法。
